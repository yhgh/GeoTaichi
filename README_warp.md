# GeoWarp: Warp Backend for GeoTaichi

GeoWarp is a Warp-based reimplementation of the GeoTaichi numerical solvers. It keeps the public API that the Taichi edition exposes while providing CUDA-accelerated and CPU fallback kernels via [NVIDIA Warp](https://github.com/NVIDIA/warp). This document covers day-to-day usage, supported platforms, packaging guidance, and licensing information for the Warp backend.

## Getting Started

### Prerequisites

GeoWarp requires Python 3.9 or newer. GPU execution additionally needs CUDA 11.8 or later with a compatible NVIDIA driver. Install the Warp runtime following the [official Warp instructions](https://github.com/NVIDIA/warp#installation) before using GeoWarp.

### Installation from Source

```bash
# Clone the repository
git clone https://github.com/Yihao-Shi/GeoTaichi.git
cd GeoTaichi

# (Optional) create an isolated environment
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\\Scripts\\activate

# Install runtime dependencies
python -m pip install --upgrade pip
python -m pip install -r requirements-warp.txt

# Install GeoWarp in editable mode
python -m pip install -e .
```

The `requirements-warp.txt` file is generated by the packaging helpers (see [Packaging & Release](#packaging--release)). It lists Warp, NumPy, and visualization utilities that match the regression baselines.

### Installing Pre-built Wheels

After building a wheel with the packaging script, publish it to an artifact store or install it locally:

```bash
python -m pip install dist/geowarp-<version>-py3-none-any.whl
```

### Minimal Usage

```python
from geowarp import init, ExplicitMPMSolver

runtime = init(arch="cuda", precision="float64")
solver = ExplicitMPMSolver.preset_column_collapse(device=runtime["device"].id)
for step in range(10):
    solver.step(dt=1e-3)
```

Refer to [`examples_warp/`](examples_warp/) for full parity scripts that mirror the legacy GeoTaichi examples. Each script writes `.vtu/.vts` outputs that can be visualized in ParaView exactly like the Taichi originals.

## Supported Environments

| Platform | Python | CUDA | Notes |
| --- | --- | --- | --- |
| Ubuntu 22.04 + NVIDIA GPU | 3.9 – 3.11 | 11.8 / 12.x | Primary development target; all regression scenarios validated on CUDA. |
| Ubuntu 22.04 (CPU only) | 3.9 – 3.11 | N/A | Warp CPU backend validated for regression suite and documentation examples. |
| Windows 11 + NVIDIA GPU | 3.10 | 11.8 / 12.x | Hash-grid DEM validated on RTX-series hardware; ensure `warp` wheel availability. |
| macOS 13 (Apple Silicon) | 3.10 | N/A | CPU backend runs examples and tests; GPU path unavailable. |

The regression harness in [`tests_warp/test_regression.py`](tests_warp/test_regression.py) enforces numerical tolerances across the CPU and CUDA configurations listed above. When adding a new backend or OS version, update the table and refresh the stored snapshots.

## Running Examples

1. Initialize the backend in the script (default precision is `float32`):
   ```python
   from geowarp import init
   init("cuda", precision="float64")
   ```
2. Run any mirror example, e.g.:
   ```bash
   python examples_warp/mpm/ColumnCollapse/DPmaterial.py
   ```
3. Visualize the generated `output/*.vtu` or `output/*.vts` files in ParaView using the same workflow described in the legacy README.

The examples honor the legacy command-line arguments and output cadence so that downstream automation continues to function.

### Quick Visual Validation

When you only need to verify that the Warp port reproduces representative DEM, MPM, and MPDEM behaviour, run the bundled demo script:

```bash
python demo/generate_visualizations.py --arch cpu --output demo/outputs
```

The command mirrors the regression scenarios, saving `.vtu` snapshots under `demo/outputs/` that can be opened in ParaView. Use `--scenarios` to limit the run to a subset and `--frame-interval` to control the number of saved frames.

## Regression & Benchmarking

The regression entry point `python bench_warp/run_regression.py` executes DEM, MPM, and MPDEM micro scenarios and writes refreshed snapshots to `tests_warp/regression_snapshots.json`. Continuous integration should run `pytest tests_warp/test_regression.py` on every target environment to ensure numerical drift stays within tolerance.

## Packaging & Release

1. Update the version number in `pyproject.toml` before cutting a release.
2. Export the runtime requirements:
   ```bash
   python -m pip install -U pip
   python -m pip install build
   python -m pip list --format=freeze | grep -E "^(warp|numpy|trimesh|shapely|pyevtk|imageio|rich|pynvml)" > requirements-warp.txt
   ```
3. Build the distribution artifacts:
   ```bash
   ./packaging/build_warp_wheel.sh
   ```
4. Upload `dist/*.whl` and `dist/*.tar.gz` to the desired package index.

The build script wraps `python -m build` with environment validation and ensures that the `third_party/pyevtk` vendored code is included in the wheel.

## Licensing

GeoWarp inherits the GeoTaichi [GPL-3.0 license](LICENSE). Distribute derivative works under compatible terms. Detailed third-party attribution, including NVIDIA Warp (Apache-2.0), NumPy (BSD-3-Clause), and PyEVTK (MIT), lives in [`THIRD_PARTY_NOTICES.md`](THIRD_PARTY_NOTICES.md).

If you contribute new dependencies, add their licenses to the notices file and ensure they are compatible with GPL-3.0 distribution requirements.
